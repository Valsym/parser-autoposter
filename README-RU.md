# parser-autoposter
<b>Задача:</b></b>
Для горнолыжного портала fanski.ru потребовалось создать список страниц с описанием всех (или почти всех) горнолыжных курортов трех Европейских стран: Австрии, Франции и Швейцарии. 

В декабре 2015 - январе 2016 гг. эта задача была успешно решена благодаря двум созданным блокам: парсеру контента и блоку автоматической публикации статей (автопостеру) , пример: http://fanski.ru/category/ski-resort/aus-ski </b>
Всего было опубликовано описаний к 198 курортам Австрии, 218 - Франции и 141- Швейцарии.</b>

В данном репозитории привожу описание этих двух блоков с кодом, написанным мной на PHP. 

</br>
<b>1. Парсер контента.</b>

1.1 Предподготовка (сбор ссылок, откуда будем парсить контент).
Заходим на сайт-донор, выбираем интересующий нас регион, например вся Австрия и попадаем на страницу:<br/>
http:// ..../austria/ski-resorts.html

Любым удобным способом копируем станицу с контентом и выдираем из него все ссылки на все горнолыжные курорты Австрии. Формируем примерно такой список:<br/>
file-allink.csv

1.2 Собственно сам прасер: read-link.php предельно прост (хотя кода и много).

Как видно из кода, основная логика работы парсера такова: </br>
парсер берет в цикле ссылку из file-allink.csv</br>
подготавливает запрос к сайту-донору, с которого будем парсить контент, </br>
делает запрос и получает данные: $source = request(...)</br>
Затем вызывает функцию makesnd($source,$fp); которая записывает спаршенные данные в файл fileresaus.csv</br>

Подробнее о функции request:<br/>
function request($url,$proxy_IP,$usag,$ref,$post = 0)<br/>
здесь $url - это ссылка на страницу с курортом на сайте-доноре, <br/>
$proxy_IP - случайно выбранная из списка прокси, <br/>
$usag - случайно выбранный из списка браузер, <br/>
$ref - первоначальная точка входа на сайт-донор (в проекте задавалась Главная)<br/>
Все это сделано для того, чтобы сайт-донор нас не забанил, поскольку запросов было много и подряд.<br/>

Список прокси $proxy = file('/.../proxy-list.csv'); формировался из прокси, взятых из открытых источников и затем чекался на валидность прямо непосредственно перед парсингом.

Браузеры брались из списка актуальных на момент написания парсера (см. chooseBrowser.php)

Собственно сам код функции request хорошо прокомментирован и пояснений почти не требует:  <br/>
Сначала происходит инициализация сеанса CURL:<br/>
$ch = curl_init();<br/> 
Затем curl_setopt — устанавливают параметры для сеанса CURL типа:<br/>
curl_setopt($ch, CURLOPT_PROXY, $proxy_IP );<br/>
curl_setopt($ch, CURLOPT_URL, $url ); // отправляем на $url<br/>
curl_setopt($ch, CURLOPT_HEADER, 0); // пустые заголовки<br/>
curl_setopt ($ch , CURLOPT_REFERER,$ref); // откуда пришли (с Главной)<br/>
 и после формирования всех прокси, кук, рефереров, заголовков таймаутов и т.п. вызывется собственно загрузка страницы и выдача её браузеру<br/>
$data = curl_exec($ch);<br/>
после чего сеанс связи с сайтом-донором завершается и данные возвращаются в тело основного цикла, до следующего url из списка: <br/> 
curl_close($ch);<br/> 
return $data;<br/> 

Итак, контент спаршен, вот типичный пример страничкек, которые парсились с сайта донора: Cervinia.html<br/> 
Далее дело техники - требуется извлечь нужный контент и сформировать массив необходимых нам данных. <br/> 
Этим занимается функция makesnd: <br/>
function makesnd($source, $fp){ // makesnd = make site need data<br/>
С помощью регулярных выражений такого типа:<br/>
preg_match_all('|<meta name="keywords" content="(.*?)" />|i', $source, $t); <br/>
$name = $t[1][0];<br/>
echo "</br>   Курорт: ".$name;<br/>
$drop = $t[1][1];<br/>
...<br/>
preg_match_all('|\<li class="total" title="Total Number Of Lifts:(.*?)">|i', $source, $tr); <br/>
echo "   Всего подъемников: ".$tr[1][0].". В том числе:" ;<br/>
$lift = $tr[1][0] ;<br/>
...<br/>
Формируется довольно внушительный массив данных (ключи говорят за себя сами, надеюсь понятно):<br/>
Наименование курорта, перепы высот, кол-во подъемников разных типов (бугели, креселки, гондолы, 2х,3х,4х,6ти и 8-местные и т.п.), общий километраж трасс и километраж по типам - черные синие, зелены трассы, кол-во сноупарков, их площади, даты открытия/закрытия, инфо (контактные данные), геограическая долгота и широта курорта.<br/>
$arrall = array();<br/>

$item['name'] = $name;<br/>
$item['max'] = $max;<br/>
$item['min'] = $min;<br/>
$item['drop'] = $drop;<br/>
$item['lift'] = $lift;<br/>
...<br/>
$item['openclose'] = $openclose;<br/>
$item['price'] = $price;<br/>
//$item['info'] = $info;<br/>
$item['lat'] = $lat;<br/>
$item['lon'] = $lon;<br/>

array_push($arrall, $item);<br/>

В конце функция makesnd из этой простыни данных формирует строку текста и записывает в файл fileresaus.csv
//преобразование в формат:<br/>
$content = '';<br/>
foreach ($arrall as $key => $item)<br/>
{<br/>
  $content.=$item['name'] .','. $item['max'] .',...'. $item['lon'] .','."\r\n";<br/>
}<br/>
//запись<br/>
fwrite($fp,$content);<br/>
Полный код функции я приводить не буду, принцип надеюсь понятен, а желающие получить код могут сделать заявку по контактам, указанным в моем профиле.<br/>

<b>2. Блок автоматической публикации статей на сайте fanski.ru (wordpress):</b> <br/>
post-circle1.php<br/>
Этот блок аналогичен основному циклу программы-генератора страниц проекта railway (сайт поиска ж/д билетов):<br/> https://github.com/Valsym/railway/blob/master/post-zd1.php<br/> с небольшими изменениями в сторону специфики данного проекта, поэтому приводить весь код здесь я не буду (желающие получить код опять же могут сделать заявку).<br/>
Хотелось бы обратить внимание на следующие моменты:<br/>
Предварительно для каждого курорта из списка выше парсились лого, картинки и схема трасс, а сами курорты отсортировались по регионам: Каринтия, Тироль, Верхняя Австрия и т.д. 

На сайте были предварительно сформированы Категории типа $category_slug = "Carinthia"; (Tyrol, Styria,  Salzburg и т.д.) и  на хостинг заливались файлы с отсортированными по регионам списками с данными о курортах (пример: Carinthia.csv), переформированные из общих списков данных по странам (из п.1).

В цикле читалась инфа из соответствующего файла: <br/>
fopen('/.../'.$category_slug.'.csv', "r");

Формировался заголовок статьи, описание, ключевые слова и тело поста.<br/>
Также в тело поста вставлялись заглушки для будущих шорткодов, для возможности подключения вывода данных о погоде и сервисов бронирования:<br/>
$mod=1;<br/>
$body .='[snowd res='.$name1.' mod='.$mod.']';<br/>
$body .='[pogoda res='.$name1.' lat='.$lat.' lon='.$lon.' mod='.$mod.']';<br/>

Кроме того, сразу же формировались произвольные поля для БД wordpress:<br/>
	add_post_meta($post_id, 'kms', $kms);<br/>
	add_post_meta($post_id, 'drop', $drop);<br/>
	add_post_meta($post_id, 'lat', $lat);<br/>
	add_post_meta($post_id, 'lon', $lon);<br/>
	для возможности сортировки курортов по перепаду высот и километражу трасс. А также данные геолокации (географические широта и долгота курорта), которые необходимы для подключения API погодных сервисов и партнерок бронирования.

Также в тело поста вставлялся фрейм iframe партнерки travelpayouts.com с геоданными курорта, позволяющий осуществлять поиск ближайшего жилья на онлайн карте.
	
Вот что в итоге получилось, как пример первый попавшийся курорт Австрии:<br/>
http://fanski.ru/ski-resort/aus-ski/salzburg/abtenau

********************************************************************************

После публикации списка описаний 557 курортов, вознилко естественное желание добавить в курорты данные о погоде и возможность сортировки этого списка. Для этого были разработаны еще два блока. </b>
Первый позволял публиковать на страничке описания кадого курорта текущие данные о погоде и прогноз на ближайшие 5 дней:  </br>
Давление, мм рт.ст.</br>
Видимость, км</br>
Облачность, %</br>
Температура, °C (ночь/день)</br>
</br>
Второй блок позволяет выполнять  прямо на сайте сортировку списка курортов по следующим параметрам:</br>
Страна </br>
Регион/область страны, </br>
Общий километраж горнолыжных трасс (от/до), км</br>
Вертикальный перепад высот (от/до), м</br>
Название конкретного курорта.</br>

<b>3. Блок погоды.</b><br/>
До некоторого времени на всех страничках курортов отображалась инфа о погоде от сервиса https://api.worldweatheronline.com Но поскольку это создавало большую нагрузку на хостинг, то этот сервис был отключен (см. pogoda.php).

<b>3. Блок сортировки курортов.</b><br/>
В форме сортировки: archive.php обработкой запроса на сортировку занимается функция go_filter.php

Список файлов прилагается: <br/>

fileresaus.csv<br/>
proxy-list.csv<br/>
chooseBrowser.php<br/>
Carinthia.csv<br/>
pogoda.php<br/>
go_filter.php<br/>
archive.php<br/>
Cervinia.html<br/>
В открытый доступ выложены не все файлы, о чем упоминалось выше. Чтобы получить коды полных версий файлов (по просьбе потенциального работодателя или людей заинтересованных) свяжитесь со мной на http://valsy.ru/:<br/>
file-allink.csv<br/>
post-circle1.php<br/>


2015 - 2017 © Валерий Симонов (http://valsy.ru/)
